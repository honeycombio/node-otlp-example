{"version":3,"file":"ObservableBaseMetric.js","sourceRoot":"","sources":["../../src/ObservableBaseMetric.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAmBA,OAAO,EAAE,eAAe,EAAE,MAAM,mBAAmB,CAAC;AAGpD,OAAO,EAAE,MAAM,EAAE,MAAM,UAAU,CAAC;AAClC,OAAO,EAAE,gBAAgB,EAAE,MAAM,oBAAoB,CAAC;AAEtD,IAAM,aAAa,GAAG,cAAO,CAAC,CAAC;AAE/B;;;GAGG;AACH;IACU,wCAAuB;IAI/B,8BACE,IAAY,EACZ,OAA0B,EACT,UAAqB,EACtC,QAAkB,EAClB,UAAsB,EACtB,sBAA8C,EAC9C,QAA8D;QAPhE,YASE,kBAAM,IAAI,EAAE,OAAO,EAAE,UAAU,EAAE,QAAQ,EAAE,sBAAsB,CAAC,SAEnE;QARkB,gBAAU,GAAV,UAAU,CAAW;QAOtC,KAAI,CAAC,SAAS,GAAG,QAAQ,IAAI,aAAa,CAAC;;IAC7C,CAAC;IAES,8CAAe,GAAzB,UAA0B,UAA0B;QAClD,OAAO,IAAI,eAAe,CACxB,UAAU,EACV,IAAI,CAAC,SAAS,EACd,IAAI,CAAC,UAAU,EACf,IAAI,CAAC,UAAU,CAAC,aAAa,CAAC,IAAI,CAAC,WAAW,CAAC,CAChD,CAAC;IACJ,CAAC;IAEc,8CAAe,GAA9B;;;;;;wBACQ,gBAAgB,GAAG,IAAI,gBAAgB,EAAE,CAAC;wBAChD,qBAAM,IAAI,CAAC,SAAS,CAAC,gBAAgB,CAAC,EAAA;;wBAAtC,SAAsC,CAAC;wBAEvC,IAAI,CAAC,eAAe,CAAC,gBAAgB,CAAC,CAAC;wBAEvC,sBAAO,iBAAM,eAAe,WAAE,EAAC;;;;KAChC;IAES,8CAAe,GAAzB,UAA0B,gBAAkC;QAA5D,iBAKC;QAJC,gBAAgB,CAAC,MAAM,CAAC,OAAO,CAAC,UAAC,KAAK,EAAE,UAAU;YAChD,IAAM,UAAU,GAAG,KAAI,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;YACzC,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;QAC3B,CAAC,CAAC,CAAC;IACL,CAAC;IAED,0CAAW,GAAX,UAAY,KAAa;QACvB,OAAO;YACL,KAAK,OAAA;YACL,UAAU,EAAE,IAA4B;SACzC,CAAC;IACJ,CAAC;IACH,2BAAC;AAAD,CAAC,AAjDD,CACU,MAAM,GAgDf","sourcesContent":["/*\n * Copyright The OpenTelemetry Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport * as api from '@opentelemetry/api-metrics';\nimport { Observation } from '@opentelemetry/api-metrics';\nimport { InstrumentationLibrary } from '@opentelemetry/core';\nimport { Resource } from '@opentelemetry/resources';\nimport { BoundObservable } from './BoundInstrument';\nimport { Processor } from './export/Processor';\nimport { MetricKind, MetricRecord } from './export/types';\nimport { Metric } from './Metric';\nimport { ObservableResult } from './ObservableResult';\n\nconst NOOP_CALLBACK = () => {};\n\n/**\n * This is a SDK implementation of Base Observer Metric.\n * All observables should extend this class\n */\nexport abstract class ObservableBaseMetric\n  extends Metric<BoundObservable>\n  implements api.ObservableBase {\n  protected _callback: (observableResult: api.ObservableResult) => unknown;\n\n  constructor(\n    name: string,\n    options: api.MetricOptions,\n    private readonly _processor: Processor,\n    resource: Resource,\n    metricKind: MetricKind,\n    instrumentationLibrary: InstrumentationLibrary,\n    callback?: (observableResult: api.ObservableResult) => unknown\n  ) {\n    super(name, options, metricKind, resource, instrumentationLibrary);\n    this._callback = callback || NOOP_CALLBACK;\n  }\n\n  protected _makeInstrument(attributes: api.Attributes): BoundObservable {\n    return new BoundObservable(\n      attributes,\n      this._disabled,\n      this._valueType,\n      this._processor.aggregatorFor(this._descriptor)\n    );\n  }\n\n  override async getMetricRecord(): Promise<MetricRecord[]> {\n    const observableResult = new ObservableResult();\n    await this._callback(observableResult);\n\n    this._processResults(observableResult);\n\n    return super.getMetricRecord();\n  }\n\n  protected _processResults(observableResult: ObservableResult): void {\n    observableResult.values.forEach((value, attributes) => {\n      const instrument = this.bind(attributes);\n      instrument.update(value);\n    });\n  }\n\n  observation(value: number): Observation {\n    return {\n      value,\n      observable: this as ObservableBaseMetric,\n    };\n  }\n}\n"]}